<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FF14 潜水艦：帰還時刻管理（ver.1.2.0）</title>
<meta name="theme-color" content="#0f1220" />
<!-- 検索避け（GitHub Pages でも有効） -->
<meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
<meta name="googlebot" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
<meta name="referrer" content="no-referrer">
<style>
  :root { --bg:#0f1220; --card:#171a2b; --border:#232946; --text:#e6ebff; --muted:#9aa3c7; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  header{padding:16px;border-bottom:1px solid var(--border)}
  h1{margin:0;font-size:18px}
  main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:16px}
  .card{background:#161a2b;border:1px solid var(--border);border-radius:12px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select{border-radius:10px;border:1px solid var(--border);background:#0c1020;color:#e6ebff;padding:8px 10px}
  input.name{width:220px}
  button{cursor:pointer}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}
  .small{font-size:12px;color:var(--muted)}
  .preview{max-width:100%;border:1px solid var(--border);border-radius:8px;display:none;margin-top:6px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#24304f;color:#cfe;border:1px solid #2f3a64}
  details{border:1px dashed var(--border);border-radius:10px;padding:6px 10px}
  summary{cursor:pointer}
</style>
</head>
<body>
<header class="row">
  <h1 id="appTitle">FF14 潜水艦：帰還時刻管理（ver.1.2.0）</h1>
</header>

<main>
  <!-- 操作列 -->
  <section class="card">
    <div class="row">
      <input id="file" type="file" accept="image/*" />
      <button id="btnOcr" disabled>OCRして帰還時刻を更新</button>
      <span class="small">ファイル名は <code>ffxiv_YYYYMMDD_HHMMSS_*.png</code> を基準にします。</span>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnNotify">通知を許可</button>
      <label class="row small" style="gap:6px">
        アラーム:
        <select id="alarmMinutes">
          <option value="0">なし</option>
          <option value="1">1分前</option>
          <option value="5" selected>5分前</option>
          <option value="10">10分前</option>
          <option value="30">30分前</option>
        </select>
      </label>
      <button id="btnExport">Googleカレンダー（.ics）出力</button>
      <button id="btnClear" title="入力された名前・時刻・通知履歴・プレビュー画像を全てクリアします">全クリア</button>
      <span class="small">※ .ics は VALARM を含みます</span>
    </div>
    <img id="preview" class="preview" alt="preview"/>
  </section>

  <!-- スケジュール -->
  <section class="card">
    <table>
      <thead>
        <tr><th>潜水艦名（編集可）</th><th>帰還時間</th><th>残り</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="small" style="margin-top:6px">
      初期値: <code>submarine-1</code> ～ <code>submarine-4</code>。編集内容と帰還時刻はブラウザに保存されます。
    </div>
  </section>

  <!-- 通知テスト -->
  <section class="card">
    <details open>
      <summary>通知の診断 / テスト</summary>
      <div class="row">
        <button id="btnStatus">状態確認</button>
        <label class="row small" style="gap:6px">
          テスト:
          <select id="testDelay">
            <option value="0">今すぐ</option>
            <option value="5000" selected>5秒後</option>
            <option value="10000">10秒後</option>
          </select>
        </label>
        <button id="btnTest">通知テストを実行</button>
        <button id="btnSwRaw" title="Service Worker 直接の通知呼び出し">SW直接表示テスト</button>
      </div>
      <div id="notifyDiag" class="small" style="margin-top:6px;white-space:pre-wrap"></div>
    </details>
  </section>

  <!-- 処理ログ / Thinking（実行手順ログ） -->
  <section class="card">
    <details open>
      <summary>処理ログ / Thinking（実行手順ログ）</summary>
      <div id="thinkLog" class="small" style="white-space:pre-wrap"></div>
    </details>
  </section>

  <!-- OCRログ -->
  <section class="card">
    <details>
      <summary>OCRログ</summary>
      <div id="ocrStatus" class="small" style="margin:6px 0">画像を選ぶとOCRできます。</div>
      <div id="rawText" class="small" style="white-space:pre-wrap;display:none"></div>
    </details>
  </section>

  <!-- 内蔵テスト -->
  <section class="card">
    <details>
      <summary>内蔵テスト</summary>
      <div id="tests" class="small"></div>
    </details>
  </section>
</main>

<!-- Tesseract 本体（CORS 安定のため crossorigin を指定） -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js" crossorigin="anonymous"></script>
<script>
/* =========================
   バージョン
========================= */
const APP_VERSION = '1.2.0';

/* =========================
   ログ出力（通知ログ / 処理ログ）
========================= */
function logArea(elId, msg){
  const el = document.getElementById(elId);
  if(!el) return;
  el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}\n` + (el.textContent || '');
}
function logNotify(msg){ logArea('notifyDiag', msg); }
function think(msg){ logArea('thinkLog', msg); }

/* 例外を画面下に出す */
window.addEventListener('error', (e)=>{ logNotify(`JSエラー: ${e.message}`); });
window.addEventListener('unhandledrejection', (e)=>{ logNotify(`Promise拒否: ${e.reason}`); });

/* =========================
   SW登録（通知を確実に）
========================= */
let swReady = null;
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js', { scope: './' })
    .then(() => { swReady = navigator.serviceWorker.ready; logNotify('SW: 登録OK'); })
    .catch(e => logNotify('SW: 登録失敗 ' + e.message));
} else {
  logNotify('この環境は Service Worker 未対応です（file:// では動作しません）');
}

/* =========================
   小物ユーティリティ
========================= */
const DEFAULT_NAMES = ['submarine-1','submarine-2','submarine-3','submarine-4'];
const STORE = 'ff14-sub-eta-with-names-v2';
const STORE_FIRED = 'ff14-sub-eta-with-names-v2-fired';

const z = n => String(n).padStart(2,'0');
function fmtLocal(d){ return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`; }
function humanLeft(ms){
  if(!isFinite(ms)) return '-';
  const neg=ms<0; ms=Math.abs(ms);
  const s=Math.floor(ms/1000);
  const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60;
  return (neg?'-':'')+`${h}時間 ${m}分 ${z(ss)}秒`;
}
function normalizeJaSpaces(s){
  let t = s.replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0)-0xFEE0))
           .replace(/[：]/g,':').replace(/\u3000/g,' ')
           .replace(/[ \t]+/g,' ').replace(/\s+\n/g,'\n').trim();
  // 日本語の間の空白を除去（OCR対策）
  t = t.replace(/([\u3040-\u30FF\u3400-\u9FFF])\s+(?=[\u3040-\u30FF\u3400-\u9FFF])/g, '$1');
  return t;
}
/** ffxiv_YYYYMMDD_HHMMSS_* → Date(ローカル) */
function parseFileTimestamp(filename){
  const m = filename.match(/ffxiv_(\d{8})_(\d{6})/i);
  if(!m) return null;
  const y=+m[1].slice(0,4), mo=+m[1].slice(4,6)-1, d=+m[1].slice(6,8);
  const hh=+m[2].slice(0,2), mm=+m[2].slice(2,4), ss=+m[2].slice(4,6);
  return new Date(y,mo,d,hh,mm,ss);
}

/* =========================
   OCRパターン & 解析
========================= */
const SUB_RE = /S\s*U\s*B\s*M\s*A\s*R\s*I\s*N\s*E/i;
const SUB_NUM_RE = /S\s*U\s*B\s*M\s*A\s*R\s*I\s*N\s*E\s*[-‐-‒–—ー]?\s*([0-9]+)/i;

function tokenToNumber(tok){
  if(!tok) return null;
  let t = tok;
  t = t.replace(/[０-９]/g, d => String.fromCharCode(d.charCodeAt(0)-0xFEE0));
  t = t.replace(/[Oo〇]/g,'0').replace(/[Il|Ｉｌ｜]/g,'1').replace(/[Z乙二]/g,'2').replace(/[Ss]/g,'5');
  t = t.replace(/\s+/g,'').replace(/[^\d]/g,'');
  if(!t) return null;
  return parseInt(t,10);
}
/** 残り時間 … を含む厳密版 */
function readHMStrict(s){
  const m1 = s.match(/残り時間\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*日\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*時間\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*分/i);
  if(m1){ const d=tokenToNumber(m1[1]),h=tokenToNumber(m1[2]),mm=tokenToNumber(m1[3]); if(d!=null&&h!=null&&mm!=null) return {h:d*24+h,mm}; }
  const m2 = s.match(/残り時間\s*([0-9０-９OIlZ乙二〇\s]{1,6})\s*時間\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*分/i);
  if(m2){ const h=tokenToNumber(m2[1]),mm=tokenToNumber(m2[2]); if(h!=null&&mm!=null) return {h,mm}; }
  return null;
}
/** 見出しに残り時間があり、行は「21時間22分」等だけのレイアウト用 */
function readHMLoose(s){
  const m3 = s.match(/([0-9０-９OIlZ乙二〇\s]{1,3})\s*日\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*時間\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*分/i);
  if(m3){ const d=tokenToNumber(m3[1]),h=tokenToNumber(m3[2]),mm=tokenToNumber(m3[3]); if(d!=null&&h!=null&&mm!=null) return {h:d*24+h,mm}; }
  const m4 = s.match(/([0-9０-９OIlZ乙二〇\s]{1,6})\s*時間\s*([0-9０-９OIlZ乙二〇\s]{1,3})\s*分/i);
  if(m4){ const h=tokenToNumber(m4[1]),mm=tokenToNumber(m4[2]); if(h!=null&&mm!=null) return {h,mm}; }
  return null;
}
/** bbox取得（なければ null） */
function getBBox(L){
  const bb = L?.bbox || L?.bbl || L?.boundingBox || null;
  if(!bb) return null;
  const n = v => Number.isFinite(+v) ? +v : NaN;
  const x0=n(bb.x0), x1=n(bb.x1), y0=n(bb.y0), y1=n(bb.y1);
  if(!Number.isFinite(x0)||!Number.isFinite(x1)||!Number.isFinite(y0)||!Number.isFinite(y1)) return null;
  return {x0,x1,y0,y1};
}
/** y近接でクラスタ選択（NaNセーフ） */
function pickBestCluster(cands, imgW){
  const finite = cands.filter(c=>Number.isFinite(c.cy));
  const base = finite.length ? finite : cands.map(c=>({...c, cy: 0}));
  if(base.length===0) return [];
  const heights = base.map(c=>c.hgt||24).filter(Number.isFinite).sort((a,b)=>a-b);
  const med = heights[Math.floor(heights.length/2)] || 24;
  const th = Math.max(20, Math.min(60, med*1.5));
  base.sort((a,b)=> (a.cy-b.cy) || 0);
  const clusters=[]; for(const c of base){
    const last=clusters[clusters.length-1];
    if(!last || Math.abs(c.cy-last.lastCy)>th){ clusters.push({items:[c],lastCy:c.cy}); }
    else { last.items.push(c); last.lastCy=c.cy; }
  }
  let best=clusters[0],score=-1;
  for(const cl of clusters){
    const xs=cl.items.map(i=>i.x0).filter(Number.isFinite);
    const ys=cl.items.map(i=>i.cy).filter(Number.isFinite);
    const xspread=xs.length?(Math.max(...xs)-Math.min(...xs)):9999;
    const vspread=ys.length?(Math.max(...ys)-Math.min(...ys)):9999;
    const cx=xs.length? (Math.max(...xs)+Math.min(...xs))/2 : imgW/2;
    const centerDist=Math.abs(cx-imgW/2);
    const s=cl.items.length*1000 - xspread - vspread - centerDist*0.1;
    if(s>score){score=s;best=cl;}
  }
  return best.items;
}
/** OCR→ minutes[]（探索完了=0分対応） */
async function buildMinutesFromOCR(worker, data, imgEl){
  const lineObjs=[]; const lines=Array.isArray(data.lines)?data.lines:[];
  for(const L of lines){
    const text=L?.text??''; const s=normalizeJaSpaces(text);
    if(/探索完了/.test(s)){
      const bb=getBBox(L);
      lineObjs.push({mins:0,isSub:SUB_RE.test(s),num:(s.match(SUB_NUM_RE)||[])[1]?+RegExp.$1:null,
        x0:bb?bb.x0:NaN,x1:bb?bb.x1:NaN,cy:bb?(bb.y0+bb.y1)/2:NaN,hgt:bb?(bb.y1-bb.y0):24});
      continue;
    }
    let hm=readHMStrict(s)||readHMLoose(s);
    if(!hm) continue;
    const bb=getBBox(L); const isSub=SUB_RE.test(s); const numM=s.match(SUB_NUM_RE);
    lineObjs.push({mins:hm.h*60+hm.mm,isSub,num=numM?+numM[1]:null,
      x0:bb?bb.x0:NaN,x1:bb?bb.x1:NaN,cy:bb?(bb.y0+bb.y1)/2:NaN,hgt:bb?(bb.y1-bb.y0):24});
  }
  if(lineObjs.length===0){
    const raw=(data.text||'').split(/\n/).map(s=>normalizeJaSpaces(s));
    for(const s of raw){
      if(/探索完了/.test(s)){ lineObjs.push({mins:0,isSub:SUB_RE.test(s),num:(s.match(SUB_NUM_RE)||[])[1]?+RegExp.$1:null,x0:NaN,x1:NaN,cy:NaN,hgt:24}); continue; }
      let hm=readHMStrict(s)||readHMLoose(s); if(!hm) continue;
      const numM=s.match(SUB_NUM_RE);
      lineObjs.push({mins:hm.h*60+hm.mm,isSub:SUB_RE.test(s),num=numM?+numM[1]:null,x0:NaN,x1:NaN,cy:NaN,hgt:24});
    }
  }
  if(lineObjs.length===0) return [];
  let chosen=[]; const subs=lineObjs.filter(v=>v.isSub);
  if(subs.length>=2){
    chosen=subs.sort((a,b)=> (Number.isFinite(a.num)&&Number.isFinite(b.num))?a.num-b.num:(a.cy-b.cy));
  }else{
    const imgW=imgEl?.naturalWidth||2000;
    chosen=pickBestCluster(lineObjs,imgW).sort((a,b)=> (a.cy-b.cy)||0);
  }
  return chosen.slice(0,4).map(v=>v.mins);
}

/* =========================
   状態保存
========================= */
function makeDefaultRows(){ return DEFAULT_NAMES.map(n=>({name:n, eta:null})); }
function load(){
  try{
    const raw=localStorage.getItem(STORE);
    if(raw){
      const parsed=JSON.parse(raw);
      if(Array.isArray(parsed)&&parsed.length===4){
        return parsed.map((r,i)=>({ name:r.name||DEFAULT_NAMES[i], eta:r.eta||null }));
      }
    }
  }catch{}
  return makeDefaultRows();
}
function save(rows){ localStorage.setItem(STORE, JSON.stringify(rows)); }
function loadFired(){ try{ return new Set(JSON.parse(localStorage.getItem(STORE_FIRED)||'[]')); }catch{ return new Set(); } }
function saveFired(set){ try{ localStorage.setItem(STORE_FIRED, JSON.stringify([...set])); }catch{} }
const state = { rows: load(), fired: loadFired() };

/* =========================
   通知（SW優先＋明示アイコン＋アプリ名）
========================= */
const FIRE_TOLERANCE_MS = 15*60*1000;
const alarmTimers = new Map();
const ICON = 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"128\" height=\"128\" viewBox=\"0 0 128 128\"><rect width=\"128\" height=\"128\" rx=\"24\" fill=\"#0f1220\"/><path d=\"M20 74h88v8H20z\" fill=\"#65d1ff\"/><path d=\"M24 70c8-16 32-22 44-22s36 6 44 22H24z\" fill=\"#a6e1ff\"/><circle cx=\"44\" cy=\"82\" r=\"6\" fill=\"#fff\"/><circle cx=\"84\" cy=\"82\" r=\"6\" fill=\"#fff\"/></svg>');
const BADGE = ICON;

function scheduleOne(etaISO, minsBefore){
  const eta = new Date(etaISO).getTime();
  const fireAt = eta - minsBefore*60000;
  const key = `${etaISO}|m${minsBefore}`;
  if(state.fired.has(key)) return;
  const delay = fireAt - Date.now();
  if(delay <= 0 && delay >= -FIRE_TOLERANCE_MS){
    notifyNow('帰還間近', `${minsBefore}分後に帰還（${fmtLocal(new Date(eta))}）`);
    state.fired.add(key); saveFired(state.fired); return;
  }
  if(delay < -FIRE_TOLERANCE_MS) return;
  if(alarmTimers.has(key)) clearTimeout(alarmTimers.get(key));
  const id = setTimeout(()=>{
    const now = Date.now();
    if(now >= fireAt - 2000 && now <= fireAt + FIRE_TOLERANCE_MS){
      notifyNow('帰還間近', `${minsBefore}分後に帰還（${fmtLocal(new Date(eta))}）`);
      state.fired.add(key); saveFired(state.fired);
    }
    alarmTimers.delete(key);
  }, Math.max(0, delay));
  alarmTimers.set(key, id);
  logNotify(`予約: ${new Date(fireAt).toLocaleString()} に ${minsBefore}分前通知（ETA ${fmtLocal(new Date(eta))}）`);
}
function rescheduleAll(){
  for(const id of alarmTimers.values()) clearTimeout(id);
  alarmTimers.clear();
  const minsBefore = +document.getElementById('alarmMinutes').value || 0;
  if(!minsBefore){ logNotify('アラーム: なし'); return; }
  for(const r of state.rows){ if(r.eta) scheduleOne(r.eta, minsBefore); }
}
async function beep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator(); const gain = ctx.createGain();
    osc.type='sine'; osc.frequency.value=880; gain.gain.value=0.06;
    osc.connect(gain).connect(ctx.destination); osc.start();
    setTimeout(()=>{ osc.stop(); ctx.close(); }, 200);
  }catch{}
}
async function notifyNow(title, body, { sticky = false } = {}){
  const appTitle = '【FF14 潜水艦タイマー】' + title;
  if(!('Notification' in window)){
    alert(`${appTitle}\n${body}`); return;
  }
  if(Notification.permission!=='granted'){
    logNotify('通知: permission='+Notification.permission);
    alert(`${appTitle}\n${body}`); return;
  }
  const options = {
    body,
    tag: sticky ? `test-${Date.now()}` : 'ff14-submarine',
    renotify: !sticky,
    requireInteraction: sticky || document.hidden,
    silent: false,
    icon: ICON,
    badge: BADGE
  };
  try{
    if(swReady){
      const reg = await swReady;
      await reg.showNotification(appTitle, options);
      logNotify('通知: SW showNotification');
    }else{
      new Notification(appTitle, options);
      logNotify('通知: window Notification');
    }
  }catch(e){
    logNotify('通知エラー: '+e.message);
    try{ new Notification(appTitle, options); }catch{}
  }
  if(document.visibilityState==='visible'){ beep(); }
}

/* =========================
   表示更新
========================= */
function render(){
  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  state.rows.forEach((r,i)=>{
    const eta = r.eta ? new Date(r.eta) : null;
    const left = eta ? (eta.getTime() - Date.now()) : NaN;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="name" data-i="${i}" value="${r.name}" /></td>
      <td>${eta ? `<span class="pill" data-eta="${eta.toISOString()}">${fmtLocal(eta)}</span>` : '-'}</td>
      <td class="left" data-left="${r.eta||''}">${eta?humanLeft(left):'-'}</td>`;
    tbody.appendChild(tr);
  });
  rescheduleAll();
}

/* 名前編集の保存 */
document.addEventListener('input', (ev)=>{
  const el = ev.target;
  if(el && el.classList && el.classList.contains('name')){
    const i = +el.getAttribute('data-i');
    let val = (el.value||'').trim();
    if(!val) val = DEFAULT_NAMES[i];
    state.rows[i].name = val;
    save(state.rows);
    if(el.value.trim()==='') el.value = val;
    think(`名前編集: row${i+1} -> "${val}"`);
  }
});

/* カウントダウン更新 */
function tick(){
  document.querySelectorAll('[data-left]').forEach(el=>{
    const etaISO = el.getAttribute('data-left'); if(!etaISO){ el.textContent='-'; return; }
    const eta = new Date(etaISO).getTime();
    const left = eta - Date.now();
    el.textContent = left<=0 ? '帰還済み' : humanLeft(left);
  });
  const minsBefore = +document.getElementById('alarmMinutes').value || 0;
  if(minsBefore>0 && 'Notification' in window && Notification.permission==='granted'){
    for(const r of state.rows){
      if(!r.eta) continue;
      const etaISO=r.eta, eta=new Date(etaISO).getTime();
      const key=`${etaISO}|m${minsBefore}`;
      const fireAt = eta - minsBefore*60000;
      if(!state.fired.has(key) && Date.now() >= fireAt && Date.now() <= fireAt + FIRE_TOLERANCE_MS){
        notifyNow('帰還間近', `${minsBefore}分後に帰還（${fmtLocal(new Date(eta))}）`);
        state.fired.add(key); saveFired(state.fired);
      }
    }
  }
}

/* =========================
   全クリア
========================= */
function clearAll(){
  if(!confirm('入力された潜水艦名、帰還時刻、通知履歴、画像プレビューをすべてクリアします。よろしいですか？')) return;
  for(const id of alarmTimers.values()) clearTimeout(id);
  alarmTimers.clear();
  state.rows = DEFAULT_NAMES.map(n=>({name:n, eta:null}));
  state.fired = new Set();
  localStorage.removeItem(STORE);
  localStorage.removeItem(STORE_FIRED);
  const file = document.getElementById('file'); if(file) file.value = '';
  const img = document.getElementById('preview'); if(img){ img.src=''; img.style.display='none'; }
  document.getElementById('ocrStatus').textContent = 'クリアしました。必要なら画像を選び直してください。';
  const raw = document.getElementById('rawText'); raw.textContent=''; raw.style.display='none';
  render();
  think('全クリアを実行しました');
}
document.getElementById('btnClear').addEventListener('click', clearAll);

/* =========================
   OCR 実行（フォールバック付き）
========================= */
function ensureTesseract(){
  if(window.Tesseract && typeof window.Tesseract.createWorker === 'function') return true;
  logNotify('Tesseract が読み込めていません。ネットワーク/拡張機能/CSP を確認してください。');
  return false;
}
async function createTessWorkerWithFallback(){
  const attempts = [
    { workerPath:'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
      corePath:'https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js',
      langPath:'https://tessdata.projectnaptha.com/5.0.0_fast',
      label:'v5/fast' },
    { workerPath:'https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js',
      corePath:'https://cdn.jsdelivr.net/npm/tesseract.js-core@5/tesseract-core.wasm.js',
      langPath:'https://tessdata.projectnaptha.com/5.0.0_best',
      label:'v5/best' },
    'default'
  ];
  for(const a of attempts){
    try{
      if(a==='default'){
        think('OCR: default worker を試行');
        const w = await Tesseract.createWorker({ logger:m=>{ if(m.progress!=null) think(`OCR: ${m.status} ${(m.progress*100).toFixed(1)}%`);} });
        await w.loadLanguage('jpn+eng'); await w.initialize('jpn+eng');
        return w;
      }else{
        think(`OCR: worker 構成を試行 (${a.label})`);
        const w = await Tesseract.createWorker({ ...a, logger:m=>{ if(m.progress!=null) think(`OCR: ${m.status} ${(m.progress*100).toFixed(1)}%`);} });
        await w.loadLanguage('jpn+eng'); await w.initialize('jpn+eng');
        return w;
      }
    }catch(e){
      logNotify(`OCR: ${a.label||'default'} 初期化失敗: ${e.message}`);
      continue;
    }
  }
  throw new Error('Tesseract worker の初期化に失敗しました');
}

document.getElementById('file').addEventListener('change', ev=>{
  const f = ev.target.files?.[0];
  document.getElementById('btnOcr').disabled = !f;
  if(!f) return;
  const url = URL.createObjectURL(f);
  const img = document.getElementById('preview'); img.src = url; img.style.display = 'block';
  document.getElementById('ocrStatus').textContent = '準備OK：OCRを開始できます。';
  document.getElementById('rawText').style.display='none';
  think(`画像選択: ${f.name}`);
});
document.getElementById('btnOcr').addEventListener('click', async()=>{
  if(!ensureTesseract()) { alert('Tesseract の読み込みに失敗しています。ページを再読み込みしてください。'); return; }
  const f = document.getElementById('file').files?.[0]; if(!f) return;
  const baseTime = parseFileTimestamp(f.name) || new Date();
  document.getElementById('ocrStatus').textContent = `OCR処理中…（基準時刻: ${fmtLocal(baseTime)}）`;
  const imgEl=document.getElementById('preview'); if(!imgEl.complete) await imgEl.decode();
  think('OCR開始: worker作成');
  let worker = null;
  try{
    worker = await createTessWorkerWithFallback();
    think('OCR: 認識実行');
    const { data } = await worker.recognize(f);
    const raw = data.text || '';
    document.getElementById('rawText').textContent = raw; document.getElementById('rawText').style.display='block';
    think(`OCR: 行数=${(data.lines||[]).length}`);

    const minsList = await buildMinutesFromOCR(worker, data, imgEl);
    think(`OCR: 抽出結果（分）=${JSON.stringify(minsList)}`);
    if(!minsList.length){ document.getElementById('ocrStatus').textContent = '該当形式の行が見つかりませんでした。'; return; }

    for(let i=0;i<4;i++){
      const m = minsList[i];
      if(typeof m === 'number'){
        const eta = new Date(baseTime.getTime() + m*60000);
        state.rows[i].eta = eta.toISOString();
      }
    }
    save(state.rows);
    render();
    document.getElementById('ocrStatus').textContent = `検出 ${minsList.length} 件（反映 ${Math.min(4, minsList.length)} 件）。`;
    think('OCR完了: テーブル更新 & 保存');
  }catch(e){
    console.error(e);
    document.getElementById('ocrStatus').textContent = 'OCR失敗：画像を明るく/拡大して再試行してください。';
    logNotify('OCRエラー: '+e.message);
  }finally{
    try{ if(worker) await worker.terminate(); }catch{}
    think('OCR: worker終了');
  }
});

/* =========================
   通知UI & .ics 出力
========================= */
document.getElementById('btnNotify').addEventListener('click', async()=>{
  if(!('Notification' in window)) { alert('このブラウザは通知に未対応です'); return; }
  const p = await Notification.requestPermission();
  logNotify(`権限: ${p}`);
  alert(p==='granted' ? '通知を許可しました（タブを開いたままご利用ください）' : '通知が許可されませんでした');
});
document.getElementById('alarmMinutes').addEventListener('change', ()=>{ rescheduleAll(); });

function toICSUTC(dt){
  const t = new Date(dt.getTime()-dt.getTimezoneOffset()*60000).toISOString();
  return t.replace(/[-:]/g,'').replace(/\.\d{3}Z/,'Z');
}
document.getElementById('btnExport').addEventListener('click', ()=>{
  const minsAlarm = +document.getElementById('alarmMinutes').value || 0;
  const entries = state.rows.map(r=> r.eta ? { title:`${r.name} 帰還`, eta:new Date(r.eta) } : null).filter(Boolean);
  if(!entries.length){ alert('エクスポート対象の帰還時刻がありません'); return; }

  const lines = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//FF14-SubTimer//JP','CALSCALE:GREGORIAN','METHOD:PUBLISH'];
  entries.forEach(({title, eta},i)=>{
    const dt = toICSUTC(eta);
    const end = toICSUTC(new Date(eta.getTime()+60*1000)); // 1分イベント
    lines.push('BEGIN:VEVENT', `UID:${Date.now()}-${i}@ff14-sub`, `DTSTAMP:${dt}`, `DTSTART:${dt}`, `DTEND:${end}`, `SUMMARY:${title}`);
    if(minsAlarm>0){ lines.push('BEGIN:VALARM','ACTION:DISPLAY',`TRIGGER:-PT${minsAlarm}M`,'DESCRIPTION:Submarine return','END:VALARM'); }
    lines.push('END:VEVENT');
  });
  lines.push('END:VCALENDAR');

  const blob = new Blob([lines.join('\r\n')], {type:'text/calendar'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ff14_submarine_returns.ics'; a.click();
});

/* =========================
   通知診断 / テスト（sticky=true）
========================= */
document.getElementById('btnStatus').addEventListener('click', ()=>{
  const p = 'Notification' in window ? Notification.permission : 'unsupported';
  logNotify(`権限=${p} / SW=${!!swReady} / 予約=${alarmTimers.size}件 / アラーム=${document.getElementById('alarmMinutes').value}分前`);
  think(`環境: origin=${location.origin}, isSecureContext=${isSecureContext}, href=${location.href}`);
});
document.getElementById('btnTest').addEventListener('click', ()=>{
  const delay = +document.getElementById('testDelay').value || 0;
  setTimeout(()=>{
    notifyNow('テスト通知', delay ? `${delay/1000}秒テスト完了` : '即時テスト完了', { sticky: true });
  }, delay);
  logNotify(`テスト予約: ${delay}ms 後`);
});
document.getElementById('btnSwRaw').addEventListener('click', async()=>{
  try{
    const reg = await (swReady || navigator.serviceWorker.ready);
    await reg.showNotification('【FF14 潜水艦タイマー】SW直通知', { body:'Service Worker 直接呼び出し', requireInteraction:true, tag:`swraw-${Date.now()}`, icon:ICON, badge:BADGE });
    logNotify('SW直: showNotification 成功');
  }catch(e){
    logNotify('SW直: 失敗 ' + e.message);
  }
});

/* =========================
   内蔵テスト & 初期化
========================= */
function test(name, fn){
  const el=document.getElementById('tests');
  try{ fn(); el.innerHTML += `✅ ${name}<br/>`; }
  catch(e){ el.innerHTML += `❌ ${name} — ${e.message}<br/>`; console.error(name, e); }
}
function assert(c,m){ if(!c) throw new Error(m||'assert'); }

(function init(){
  document.title = `FF14 潜水艦：帰還時刻管理（ver.${APP_VERSION}）`;
  document.getElementById('appTitle').textContent = `FF14 潜水艦：帰還時刻管理（ver.${APP_VERSION}）`;

  test('humanLeft 3661s → 1時間 1分 01秒', ()=>{ const s = humanLeft(3661*1000); assert(/1時間 1分 01秒/.test(s),'format'); });
  render();
  setInterval(tick, 1000);
  think('初期化: レンダリング/カウントダウン開始');
})();
</script>
</body>
</html>
